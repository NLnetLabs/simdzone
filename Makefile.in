#
# Makefile.in -- one file to make them all
#
# Copyright (c) 2022-2024, NLnet Labs. All rights reserved.
#
# SPDX-License-Identifier: BSD-3-Clause
#
WESTMERE = @HAVE_WESTMERE@
HASWELL = @HAVE_HASWELL@

CC = @CC@
CPPFLAGS = @CPPFLAGS@ -I$(srcdir)/include -I$(srcdir)/src -I.
CFLAGS = @CFLAGS@
DEPFLAGS = -MT $@ -MMD -MP -MF $(@:.o=.d)
srcdir = @srcdir@
VPATH = @srcdir@

SOURCES = src/zone.c src/fallback/parser.c

OBJECTS = $(SOURCES:.c=.o)
NO_OBJECTS =

WESTMERE_SOURCES = src/westmere/parser.c
WESTMERE_OBJECTS = $(WESTMERE_SOURCES:.c=.o)

HASWELL_SOURCES = src/haswell/parser.c
HASWELL_OBJECTS = $(HASWELL_SOURCES:.c=.o)

EXPORT_HEADER = include/zone/export.h

.PHONY: all clean

all: libzone.a

clean:
	@rm -f libzone.a
	@rm -f $(OBJECTS) $(OBJECTS:.o=.d)
	@rm -f $(WESTMERE_OBJECTS) $(WESTMERE_OBJECTS:.o=.d)
	@rm -f $(HASWELL_OBJECTS) $(HASWELL_OBJECTS:.o=.d)

distclean: clean
	@rm -f Makefile config.h config.log config.status

realclean: distclean
	@rm -rf autom4te*

libzone.a: $(EXPORT_HEADER) $(OBJECTS) $($(WESTMERE)_OBJECTS) $($(HASWELL)_OBJECTS)
	$(AR) rcs libzone.a $(OBJECTS) $($(WESTMERE)_OBJECTS) $($(HASWELL)_OBJECTS)


$(EXPORT_HEADER):
	@mkdir -p include/zone
	@echo "#define ZONE_EXPORT" > include/zone/export.h

$(OBJECTS):
	@mkdir -p src/fallback
	$(CC) $(DEPFLAGS) $(CPPFLAGS) $(CFLAGS) -o $@ -c $(srcdir)/$(@:.o=.c)

$(WESTMERE_OBJECTS):
	@mkdir -p src/westmere
	$(CC) $(DEPFLAGS) $(CPPFLAGS) $(CFLAGS) -march=westmere -o $@ -c $(srcdir)/$(@:.o=.c)

$(HASWELL_OBJECTS):
	@mkdir -p src/haswell
	$(CC) $(DEPFLAGS) $(CPPFLAGS) $(CFLAGS) -march=haswell -o $@ -c $(srcdir)/$(@:.o=.c)

src/zone.o: $(srcdir)/src/zone.c src/zone.d
src/fallback/parser.o: $(srcdir)/src/fallback/parser.c src/fallback/parser.d
src/westmere/parser.o: $(srcdir)/src/westmere/parser.c src/westmere/parser.d
src/haswell/parser.o: $(srcdir)/src/haswell/parser.c src/haswell/parser.d

DEPENDS := $(SOURCES:.c=.d) \
           $($(WESTMERE)_SOURCES:.c=.d) \
           $($(HASWELL)_SOURCES:.c=.d)
$(DEPENDS):
-include $(wildcard $(DEPENDS))
