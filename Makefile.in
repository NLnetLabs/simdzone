#
# Makefile.in -- one file to make them all
#
# Copyright (c) 2022-2024, NLnet Labs. All rights reserved.
#
# SPDX-License-Identifier: BSD-3-Clause
#
WESTMERE = @HAVE_WESTMERE@
HASWELL = @HAVE_HASWELL@

CC = @CC@
CPPFLAGS = @CPPFLAGS@ -I$(SOURCE)/include -I$(SOURCE)/src -I.
CFLAGS = @CFLAGS@
DEPFLAGS = -MT $@ -MMD -MP -MF $(@:.o=.d)
VPATH = @srcdir@

WESTMERE_SOURCES = src/westmere/parser.c
WESTMERE_OBJECTS = $($(WESTMERE)_SOURCES:.c=.o)

HASWELL_SOURCES = src/haswell/parser.c
HASWELL_OBJECTS = $($(HASWELL)_SOURCES:.c=.o)

SOURCE = @srcdir@
SOURCES = src/zone.c src/fallback/parser.c
NO_SOURCES =
OBJECTS = $(SOURCES:.c=.o) \
          $($(WESTMERE)_SOURCES:.c=.o) \
          $($(HASWELL)_SOURCES:.c=.o)
DEPENDS = $(OBJECTS:.o=.d)

EXPORT_HEADER = include/zone/export.h

.PHONY: all clean

all: libzone.a

clean:
	@rm -f .depend
	@rm -f libzone.a $(OBJECTS)

distclean: clean
	@rm -f Makefile config.h config.log config.status

realclean: distclean
	@rm -rf autom4te*

libzone.a: $(EXPORT_HEADER) $(OBJECTS)
	$(AR) rcs libzone.a $(OBJECTS)

$(EXPORT_HEADER):
	@mkdir -p include/zone
	@echo "#define ZONE_EXPORT" > include/zone/export.h

$(WESTMERE_OBJECTS): CFLAGS += -march=westmere
$(HASWELL_OBJECTS): CFLAGS += -march=haswell

$(OBJECTS): .depend
	@mkdir -p src/fallback src/westmere src/haswell
	$(CC) $(DEPFLAGS) $(CPPFLAGS) $(CFLAGS) -o $@ -c $(SOURCE)/$(@:.o=.c)
	@touch $@

.depend:
	@cat /dev/null > $@
	@for x in $(OBJECTS:.o=); do echo "$${x}.o: $(SOURCE)/$${x}.c $${x}.d" >> $@; done

-include .depend
$(DEPENDS):
-include $(DEPENDS)
